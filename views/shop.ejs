<%- include("partials/header") %>
<section id="store">

  <div class="modal fade opacity-animate" id="form" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content text-left">
        <div class="modal-header border-bottom-0 ">
          <h2 class="modal-title" id="exampleModalLabel">Details</h2>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form>
          <div class="modal-body">
            <div class="form-group">
              <label for="name">Name<sup class="text-danger">*</sup></label>
              <input type="text" class="form-control" placeholder="Enter your name" required>
            </div>
            <div class="form-group">
              <label for="email1">Email address<sup class="text-danger">*</sup></label>
              <input type="email" class="form-control" id="email1" aria-describedby="emailHelp" placeholder="Enter your email" required>
              <small id="emailHelp" class="form-text text-muted">Your information is safe with us.</small>
            </div>
           
            <div class="form-group">
              <label for="address">Address<sup class="text-danger">*</sup></label>
              <input type="text" class="form-control" placeholder="Enter your address" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone no.<sup class="text-danger">*</sup></label>
              <input type="text" class="form-control" placeholder="Enter your phone no." required>
            </div>
          </div>
          <div class="modal-footer border-top-0 d-flex justify-content-center">
            <button class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
            <a id="cart-proceed" class="btn btn-proceed" data-dismiss="modal" onclick="displayRazorpay(event)">Proceed</a>
          </div>
        </form>
      </div>
    </div>
  </div>


  
    <div class="modal fade opacity-animate" id="form2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content text-left">
          <div class="modal-header border-bottom-0 ">
            <h2 class="modal-title" id="exampleModalLabel">Details</h2>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form>
            <div class="modal-body">
              <div class="form-group">
                <label for="name">Name<sup class="text-danger">*</sup> </label>
                <input type="text" class="form-control" placeholder="Enter your name" required>
              </div>
              <div class="form-group">
                <label for="email1">Email address<sup class="text-danger">*</sup></label>
                <input type="email" class="form-control" id="email1" aria-describedby="emailHelp" placeholder="Enter your email" required>
              </div>
              <div class="form-group">
                <label for="phone">Phone no.<sup class="text-danger">*</sup></label>
                <input type="text" class="form-control" placeholder="Enter your phone no." required>
              </div>
              <div class="form-group">
                <label for="text">Comment</label>
                <textarea class="form-control" rows="3" id="comment"></textarea>
              </div>  
            </div>
            <div class="modal-footer border-top-0 d-flex justify-content-center">
              <button class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
              <a id="donate-proceed" class="btn btn-proceed" data-dismiss="modal" onclick="displayRazorpay(event)">Proceed</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  
    <div class="dropdown text-left cart">
      <button class="btn btn-cart" type="button" data-toggle="dropdown">
          <i class="fas fa-shopping-cart fa-2x"></i><sub id="clickme">0</sub>
          <span class="caret "></span>
      </button>
      
      <ul class="dropdown-menu">
        <span class="empty">Your cart is empty.</span>
        <span id="total"></span><span id="cost"></span>
        <div class="button">
            <button class="btn place" data-toggle="modal" data-target="#form">Place order</button>
          </div>
      </ul>
        
    </div>
  
    <div class="donate-sm mt-5">
      <h2><span>$</span> Donate <i class="fas fa-angle-down downarrow"></i></h2>
    </div>
      <!-- <div class="sidenav">
        <h2>Donate Us</h2>
      </div> -->
      <div class="donate">
        <div class="donate-black">
          <h2><span>$</span> Donate<span class="closedonation"><i class="fas fa-times"></i></span></h2>
          <p>Your contribution is vital to the success of our initiative.</p>
        </div>
        <div class="donate-blue">
          <h3>Donation amount*</h3>
          <div class="donate-amount-box">
            <div class="donate-amount">
              <div class="denomination selected">
                <input autocomplete="off" type="radio" name="amount" id="amount5" value="5" checked="">
                <label for="amount5">₹5</label>
              </div>
              <div class="denomination">
                <input autocomplete="off" type="radio" name="amount" id="amount10" value="10">
                <label for="amount10">₹10</label>
              </div>
              <div class="denomination">
                <input autocomplete="off" type="radio" name="amount" id="amount15" value="15">
                <label for="amount15">₹15</label>
              </div>
              <div class="denomination">
                <input autocomplete="off" type="radio" name="amount" id="amount25" value="25">
                <label for="amount25">₹25</label>
              </div>
              <div class="denomination">
                <input autocomplete="off" type="radio" name="amount" id="amount50" value="50">
                <label for="amount50">₹50</label>
              </div>
              <div class="denomination">
                <input autocomplete="off" type="radio" name="amount" id="amount100" value="100">
                <label for="amount100">₹100</label>
              </div>
            </div>
            <div class="denomination-other">
                <input autocomplete="off" type="text" name="amount" value="" placeholder="Enter Other Amount">
              </div>
          </div>
  
        </div>
        <div class="donate-blue donate-payment">
          <div class="donate-submit">
            <button type="submit" autocomplete="off" class="buttonDonate" data-toggle="modal" data-target="#form2">Donate ₹<span>5</span></button>
            <p><small>Please note that contributions are not tax-deductible.</small></p>
          </div>
        </div>
      </div>
  
  
      <!-- card layout  -->
      <div class="container">
          <div class="row">
              <% items.forEach((item) => { %>
                <div class=" col-xl-4 col-lg-4 col-md-6 col-sm-6 col-xs-3 d-flex justify-content-center ">
                  <div class="card">
                      <div class="imgBox">
                          <img src="<%= item.image %>" alt="<%= item.name %>" class="img-fluid">
                      </div>
                      <div class="contentBx">
                          <h3 class="productName"><%= item.name %></h3>
                          <h2 class="price">₹<span class="productPrice"><%= item.price %></span></h2>
                          <a href="#" id="<%= item._id %>" class="buy" title="Add to my cart!">Buy Now</a>
                          <a href="#" id="<%= item._id %>" class="remove" title="Remove from my cart!">Remove</a>
                      </div>
                      <div class="inside">
                        <div class="icon"><i class="material-icons">info_outline</i></div>
                        <div class="contents">
                          <h2>Description:</h2>
                          <div class="icon2"><i class="material-icons">close</i></div>
                          <p><%= item.description %></p>
                        </div>
                      </div>
                  </div>
              </div>
              <% }); %>
            
          </div>
      </div>
     </section>

     <script>
        function loadScript(src){
          return new Promise(resolve => {
            const script = document.createElement("script");
            script.src = src;
            script.onload = () => {
              resolve(true);
            }
            script.onerror = () => {
              resolve(false);
            }
            document.body.appendChild(script);
          });
        }

        async function displayRazorpay(event){
          if(event.currentTarget.id === "donate-proceed"){
            console.log("DONATEWAAAA");
            var name = $($($("#donate-proceed").parent()).parent()[0][0]).val();
            var email = $($($("#donate-proceed").parent()).parent()[0][1]).val();
            var phone = $($($("#donate-proceed").parent()).parent()[0][2]).val();
            var address = "";
            var comment = $($($("#donate-proceed").parent()).parent()[0][3]).val();
            var amount = Number($(".buttonDonate").children()[0].innerText);
          }
          if(event.currentTarget.id === "cart-proceed"){
            console.log("CAARAATWAA");
            var name = $($($("#cart-proceed").parent()).parent()[0][0]).val();
            var email = $($($("#cart-proceed").parent()).parent()[0][1]).val();
            var phone = $($($("#cart-proceed").parent()).parent()[0][3]).val();
            var address = $($($("#cart-proceed").parent()).parent()[0][2]).val();
            var comment = "";
            var amount = Number($("#cost").text());
            var items = $(".item");
            var itemList = [];
            for(const item of items){
              itemList.push($($(item).children()[0])[0].firstElementChild.outerText);
            }
          }

          const res = await loadScript("https://checkout.razorpay.com/v1/checkout.js");
          if(!res){
            alert("Razorpay failed to load.");
            return
          }

          const data = await $.ajax({
            method: "POST",
            url: "/razorpay",
            data: {name: name, comment: comment, amount: amount, address: address, email: email, phone: phone, items: itemList || [] }
          });

          console.log(data);

          const options = {
            "key": "<%= process.env.KEYID %>",
            "currency": data.currency,
            "amount": data.amount.toString(),
            "name": "Mercer Corps",
            "description": "Donations",
            "image": "https://pbs.twimg.com/profile_images/642335556953767936/AJXCS4Ge.png",
            "order_id": data.id,
            "handler": function (response){
                if (typeof response.razorpay_payment_id == 'undefined' ||  response.razorpay_payment_id < 1) {
                  alert("Something went wrong, PLease try again!!");
                } else {
                  alert(`Your order with id: ${response.razorpay_order_id} is confirmed.
                Someone will contact you soon!`);
                  redirect_url = `/${response.razorpay_order_id}/success`;
                }
                location.href = redirect_url;
            },
            "prefill": {
                "name": name,
                "email": email,
                "contact": phone
            },
            "notes": {
              "address": address,
              "name": name,
              "comment": comment
            }
          };
          const paymentObject = new Razorpay(options);
          paymentObject.open();
        }
     </script>
<%- include("partials/footer") %>